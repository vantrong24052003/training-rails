<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rails 7: Nested Attributes, Rescue_from v√† Background Jobs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #cc0000;
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            font-weight: 300;
        }

        .content-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        h2 {
            color: #cc0000;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        h3 {
            color: #333;
            margin: 25px 0 15px;
        }

        p {
            margin-bottom: 15px;
        }

        ul,
        ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        .code-block {
            background-color: #282c34;
            border-left: 4px solid #cc0000;
            padding: 16px;
            margin: 15px 0;
            overflow-x: auto;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .code-block pre {
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
            white-space: pre;
        }

        .code-block code {
            color: #abb2bf;
            font-size: 15px;
        }

        .keyword {
            color: #c678dd;
        }

        .class-name {
            color: #e5c07b;
        }

        .method {
            color: #61afef;
        }

        .method-name {
            color: #98c379;
        }

        .symbol {
            color: #e06c75;
        }

        .string {
            color: #98c379;
        }

        .comment {
            color: #5c6370;
            font-style: italic;
        }

        .number {
            color: #d19a66;
        }

        .boolean {
            color: #56b6c2;
        }

        .variable {
            color: #e06c75;
        }

        .note {
            background-color: #e8f4fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }

        .warning {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }

        .tip {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
        }

        .terminal {
            background-color: #1e1e1e;
            color: #dcdcdc;
            padding: 16px;
            margin: 15px 0;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
        }

        .terminal .prompt {
            color: #4caf50;
        }

        .terminal .command {
            color: #dcdcdc;
        }

        .terminal .output {
            color: #9e9e9e;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .reference-links {
            list-style-type: none;
            padding-left: 0;
            margin: 20px 0;
        }

        .reference-links li {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
        }

        .reference-links li:before {
            content: "üìö";
            position: absolute;
            left: 0;
            top: 0;
        }

        .reference-links a {
            color: #cc0000;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease, border-bottom 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        .reference-links a:hover {
            color: #990000;
            border-bottom: 1px solid #990000;
        }

        .reference-links a:visited {
            color: #800000;
        }

        .step {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #cc0000;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: #cc0000;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .step-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            header {
                padding: 20px 0;
            }
            h1 {
                font-size: 2rem;
            }
            .content-section {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Rails 7: Nested Attributes, Rescue_from v√† Background Jobs</h1>
            <div class="subtitle">T√¨m hi·ªÉu v·ªÅ c√°c t√≠nh nƒÉng n√¢ng cao trong Rails 7</div>
        </header>

        <div class="content-section">
            <h2>1. Nested Attributes</h2>
            <p>Nested Attributes l√† m·ªôt t√≠nh nƒÉng m·∫°nh m·∫Ω trong Rails cho ph√©p b·∫°n l∆∞u c√°c attributes c·ªßa c√°c association models th√¥ng qua model cha. ƒêi·ªÅu n√†y ƒë·∫∑c bi·ªát h·ªØu √≠ch khi b·∫°n mu·ªën t·∫°o, c·∫≠p nh·∫≠t ho·∫∑c x√≥a c√°c records li√™n quan trong c√πng m·ªôt form.</p>

            <h3>1.1. M·ª•c ƒë√≠ch s·ª≠ d·ª•ng</h3>
            <ul>
                <li><strong>Form ph·ª©c t·∫°p:</strong> Khi b·∫°n c·∫ßn t·∫°o form cho nhi·ªÅu model c√≥ quan h·ªá v·ªõi nhau (v√≠ d·ª•: ƒë∆°n h√†ng v√† c√°c s·∫£n ph·∫©m trong ƒë∆°n)</li>
                <li><strong>Qu·∫£n l√Ω d·ªØ li·ªáu li√™n quan:</strong> Cho ph√©p ng∆∞·ªùi d√πng th√™m/s·ª≠a/x√≥a c√°c records con th√¥ng qua form c·ªßa record cha</li>
                <li><strong>T·ªëi ∆∞u UX:</strong> Gi√∫p ng∆∞·ªùi d√πng thao t√°c v·ªõi d·ªØ li·ªáu li√™n quan m√† kh√¥ng c·∫ßn chuy·ªÉn trang</li>
                <li><strong>ƒê∆°n gi·∫£n h√≥a logic:</strong> X·ª≠ l√Ω t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan trong m·ªôt transaction</li>
            </ul>

            <h3>1.2. C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn</h3>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Tr∆∞·ªùng h·ª£p</th>
                        <th>V√≠ d·ª•</th>
                        <th>L·ª£i √≠ch</th>
                    </tr>
                    <tr>
                        <td>Form ƒëƒÉng k√Ω c√≥ nhi·ªÅu th√¥ng tin ph·ª•</td>
                        <td>ƒêƒÉng k√Ω user k√®m ƒë·ªãa ch·ªâ v√† preferences</td>
                        <td>T·∫°o nhi·ªÅu records li√™n quan trong m·ªôt form</td>
                    </tr>
                    <tr>
                        <td>Qu·∫£n l√Ω danh s√°ch ƒë·ªông</td>
                        <td>T·∫°o survey v·ªõi nhi·ªÅu c√¢u h·ªèi</td>
                        <td>Th√™m/x√≥a items ƒë·ªông trong form</td>
                    </tr>
                    <tr>
                        <td>Form ch·ªânh s·ª≠a ph·ª©c t·∫°p</td>
                        <td>Ch·ªânh s·ª≠a b√†i vi·∫øt v√† c√°c tags</td>
                        <td>C·∫≠p nh·∫≠t nhi·ªÅu records li√™n quan c√πng l√∫c</td>
                    </tr>
                </table>
            </div>

            <h3>1.3. C·∫•u h√¨nh chi ti·∫øt</h3>
            <p>Nested Attributes c√≥ nhi·ªÅu options quan tr·ªçng:</p>

            <div class="code-block">
                <pre><code><span class="keyword">class</span> <span class="class-name">Survey</span> < <span class="class-name">ApplicationRecord</span>
  <span class="method">has_many</span> <span class="symbol">:questions</span>
  <span class="method">accepts_nested_attributes_for</span> <span class="symbol">:questions</span>,
    <span class="symbol">allow_destroy:</span> <span class="boolean">true</span>,           <span class="comment"># Cho ph√©p x√≥a questions</span>
    <span class="symbol">reject_if:</span> <span class="symbol">:all_blank</span>,         <span class="comment"># B·ªè qua n·∫øu t·∫•t c·∫£ fields tr·ªëng</span>
    <span class="symbol">limit:</span> <span class="number">10</span>,                     <span class="comment"># Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng questions</span>
    <span class="symbol">update_only:</span> <span class="boolean">false</span>            <span class="comment"># Cho ph√©p t·∫°o m·ªõi ho·∫∑c ch·ªâ update</span>
<span class="keyword">end</span></code></pre>
            </div>

            <div class="tip">
                <strong>M·∫πo n√¢ng cao:</strong>
                <ul>
                    <li>S·ª≠ d·ª•ng <code>inverse_of</code> trong associations ƒë·ªÉ t·ªëi ∆∞u performance</li>
                    <li>D√πng <code>autosave: true</code> ƒë·ªÉ t·ª± ƒë·ªông l∆∞u c√°c records con</li>
                    <li>Th√™m validations cho c·∫£ parent v√† child models</li>
                </ul>
            </div>

            <h3>1.4. JavaScript v√† Dynamic Forms</h3>
            <p>ƒê·ªÉ t·∫°o form ƒë·ªông v·ªõi Nested Attributes:</p>

            <div class="code-block">
                <pre><code><span class="comment"># app/views/surveys/_form.html.erb</span>
<%= <span class="method">form_with</span>(<span class="symbol">model:</span> <span class="variable">@survey</span>) <span class="keyword">do</span> |<span class="variable">f</span>| %>
  <span class="variable">f</span>.<span class="method">text_field</span> <span class="symbol">:title</span>

  <span class="comment"># Container cho questions</span>
  <span class="keyword">div</span> <span class="symbol">id:</span> <span class="string">"questions"</span> <span class="keyword">do</span>
    <span class="variable">f</span>.<span class="method">fields_for</span> <span class="symbol">:questions</span> <span class="keyword">do</span> |<span class="variable">question</span>|
      <%= <span class="method">render</span> <span class="string">'question_fields'</span>, <span class="symbol">f:</span> <span class="variable">question</span> %>
    <% <span class="keyword">end</span> %>
  <% <span class="keyword">end</span> %>

  <span class="comment"># Link th√™m question ƒë·ªông</span>
  <%= <span class="method">link_to_add_fields</span> <span class="string">'Th√™m c√¢u h·ªèi'</span>, <span class="variable">f</span>, <span class="symbol">:questions</span> %>
<% <span class="keyword">end</span> %>

<span class="comment"># app/javascript/controllers/nested_form_controller.js</span>
<span class="keyword">import</span> { <span class="class-name">Controller</span> } <span class="keyword">from</span> <span class="string">"@hotwired/stimulus"</span>

<span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="keyword">extends</span> <span class="class-name">Controller</span> {
  <span class="method">addAssociation</span>(<span class="variable">event</span>) {
    <span class="variable">event</span>.<span class="method">preventDefault</span>()
    <span class="keyword">const</span> <span class="variable">template</span> = <span class="variable">event</span>.<span class="variable">target</span>.<span class="method">dataset</span>.<span class="variable">template</span>
    <span class="keyword">const</span> <span class="variable">container</span> = <span class="keyword">document</span>.<span class="method">querySelector</span>(<span class="string">"#questions"</span>)
    <span class="variable">container</span>.<span class="variable">insertAdjacentHTML</span>(<span class="string">"beforeend"</span>, <span class="variable">template</span>)
  }
}</code></pre>
            </div>

            <div class="warning">
                <strong>L∆∞u √Ω quan tr·ªçng:</strong>
                <ul>
                    <li>C·∫©n th·∫≠n v·ªõi Mass Assignment - lu√¥n s·ª≠ d·ª•ng Strong Parameters</li>
                    <li>X·ª≠ l√Ω validation errors cho c·∫£ parent v√† child models</li>
                    <li>C√¢n nh·∫Øc performance khi c√≥ qu√° nhi·ªÅu nested records</li>
                    <li>S·ª≠ d·ª•ng transaction ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu</li>
                </ul>
            </div>

        </div>

        <div class="content-section">
            <h2>2. Rescue_from</h2>
            <p><code>rescue_from</code> l√† m·ªôt c∆° ch·∫ø x·ª≠ l√Ω exceptions t·∫≠p trung trong Rails, cho ph√©p b·∫°n ƒë·ªãnh nghƒ©a c√°ch x·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau m·ªôt c√°ch nh·∫•t qu√°n trong to√†n b·ªô ·ª©ng d·ª•ng.</p>

            <h3>2.1. M·ª•c ƒë√≠ch s·ª≠ d·ª•ng</h3>
            <ul>
                <li><strong>X·ª≠ l√Ω l·ªói t·∫≠p trung:</strong> ƒê·ªãnh nghƒ©a logic x·ª≠ l√Ω l·ªói m·ªôt l·∫ßn v√† t√°i s·ª≠ d·ª•ng</li>
                <li><strong>C·∫£i thi·ªán UX:</strong> Hi·ªÉn th·ªã th√¥ng b√°o l·ªói th√¢n thi·ªán v·ªõi ng∆∞·ªùi d√πng</li>
                <li><strong>B·∫£o m·∫≠t:</strong> Ki·ªÉm so√°t th√¥ng tin l·ªói ƒë∆∞·ª£c hi·ªÉn th·ªã ra b√™n ngo√†i</li>
                <li><strong>Logging v√† Monitoring:</strong> Theo d√µi v√† ghi nh·∫≠n l·ªói m·ªôt c√°ch c√≥ h·ªá th·ªëng</li>
            </ul>

            <h3>2.2. C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn</h3>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Exception</th>
                        <th>Tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng</th>
                        <th>X·ª≠ l√Ω ph·ªï bi·∫øn</th>
                    </tr>
                    <tr>
                        <td>ActiveRecord::RecordNotFound</td>
                        <td>Record kh√¥ng t·ªìn t·∫°i</td>
                        <td>Redirect ho·∫∑c hi·ªÉn th·ªã 404 page</td>
                    </tr>
                    <tr>
                        <td>ActiveRecord::RecordInvalid</td>
                        <td>Validation th·∫•t b·∫°i</td>
                        <td>Hi·ªÉn th·ªã form v·ªõi error messages</td>
                    </tr>
                    <tr>
                        <td>CanCan::AccessDenied</td>
                        <td>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</td>
                        <td>Redirect v√† hi·ªÉn th·ªã th√¥ng b√°o</td>
                    </tr>
                    <tr>
                        <td>ActionController::InvalidAuthenticityToken</td>
                        <td>CSRF attack</td>
                        <td>Reset session v√† redirect</td>
                    </tr>
                </table>
            </div>

            <h3>2.3. C·∫•u h√¨nh n√¢ng cao</h3>
            <div class="code-block">
                <pre><code><span class="keyword">class</span> <span class="class-name">ApplicationController</span> < <span class="class-name">ActionController::Base</span>
  <span class="method">rescue_from</span> <span class="class-name">Exception</span>, <span class="symbol">with:</span> <span class="symbol">:handle_exception</span>
  <span class="method">rescue_from</span> <span class="class-name">ActiveRecord::RecordNotFound</span>, <span class="symbol">with:</span> <span class="symbol">:handle_not_found</span>
  <span class="method">rescue_from</span> <span class="class-name">User::NotAuthorized</span>, <span class="symbol">with:</span> <span class="symbol">:handle_unauthorized</span>

  <span class="keyword">private</span>

  <span class="keyword">def</span> <span class="method-name">handle_exception</span>(<span class="variable">e</span>)
    <span class="comment"># Log l·ªói</span>
    <span class="class-name">Rails</span>.<span class="variable">logger</span>.<span class="method">error</span>(<span class="variable">e</span>.<span class="variable">message</span>)
    <span class="class-name">Rails</span>.<span class="variable">logger</span>.<span class="method">error</span>(<span class="variable">e</span>.<span class="variable">backtrace</span>.<span class="method">join</span>(<span class="string">"\n"</span>))

    <span class="comment"># Notify service monitoring</span>
    <span class="class-name">Sentry</span>.<span class="method">capture_exception</span>(<span class="variable">e</span>) <span class="keyword">if</span> <span class="class-name">Rails</span>.<span class="variable">env</span>.<span class="method">production?</span>

    <span class="comment"># Render error page</span>
    <span class="method">respond_to</span> <span class="keyword">do</span> |<span class="variable">format</span>|
      <span class="variable">format</span>.<span class="method">html</span> { <span class="method">render</span> <span class="string">'errors/500'</span>, <span class="symbol">status:</span> <span class="number">500</span> }
      <span class="variable">format</span>.<span class="method">json</span> { <span class="method">render</span> <span class="symbol">json:</span> { <span class="symbol">error:</span> <span class="string">'Internal Server Error'</span> }, <span class="symbol">status:</span> <span class="number">500</span> }
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="method-name">handle_not_found</span>(<span class="variable">e</span>)
    <span class="method">respond_to</span> <span class="keyword">do</span> |<span class="variable">format</span>|
      <span class="variable">format</span>.<span class="method">html</span> { <span class="method">render</span> <span class="string">'errors/404'</span>, <span class="symbol">status:</span> <span class="symbol">:not_found</span> }
      <span class="variable">format</span>.<span class="method">json</span> { <span class="method">render</span> <span class="symbol">json:</span> { <span class="symbol">error:</span> <span class="string">'Resource not found'</span> }, <span class="symbol">status:</span> <span class="symbol">:not_found</span> }
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="method-name">handle_unauthorized</span>(<span class="variable">e</span>)
    <span class="method">respond_to</span> <span class="keyword">do</span> |<span class="variable">format</span>|
      <span class="variable">format</span>.<span class="method">html</span> <span class="keyword">do</span>
        <span class="method">flash</span>[<span class="symbol">:alert</span>] = <span class="string">'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y'</span>
        <span class="method">redirect_to</span> <span class="method">root_path</span>
      <span class="keyword">end</span>
      <span class="variable">format</span>.<span class="method">json</span> { <span class="method">render</span> <span class="symbol">json:</span> { <span class="symbol">error:</span> <span class="string">'Unauthorized'</span> }, <span class="symbol">status:</span> <span class="symbol">:forbidden</span> }
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>
            </div>

            <div class="tip">
                <strong>Best Practices:</strong>
                <ul>
                    <li>T·∫°o c√°c custom exceptions c√≥ √Ω nghƒ©a cho ·ª©ng d·ª•ng</li>
                    <li>Ph√¢n c·∫•p exceptions ƒë·ªÉ x·ª≠ l√Ω theo nh√≥m</li>
                    <li>S·ª≠ d·ª•ng concerns ƒë·ªÉ chia s·∫ª rescue_from gi·ªØa c√°c controllers</li>
                    <li>K·∫øt h·ª£p v·ªõi logging v√† monitoring services</li>
                </ul>
            </div>

        </div>

        <div class="content-section">
            <h2>3. Background Jobs</h2>
            <p>Background Jobs l√† gi·∫£i ph√°p ƒë·ªÉ x·ª≠ l√Ω c√°c t√°c v·ª• n·∫∑ng, t·ªën th·ªùi gian ho·∫∑c kh√¥ng c·∫ßn ph·∫£n h·ªìi ngay l·∫≠p t·ª©c, gi√∫p c·∫£i thi·ªán performance v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng trong Rails applications.</p>

            <h3>3.1. M·ª•c ƒë√≠ch s·ª≠ d·ª•ng</h3>
            <ul>
                <li><strong>T·ªëi ∆∞u response time:</strong> X·ª≠ l√Ω c√°c t√°c v·ª• n·∫∑ng m√† kh√¥ng block request</li>
                <li><strong>X·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô:</strong> Th·ª±c hi·ªán c√°c t√°c v·ª• kh√¥ng c·∫ßn ph·∫£n h·ªìi ngay</li>
                <li><strong>Qu·∫£n l√Ω t√†i nguy√™n:</strong> Ph√¢n ph·ªëi t·∫£i cho h·ªá th·ªëng</li>
                <li><strong>Retry mechanism:</strong> T·ª± ƒë·ªông th·ª≠ l·∫°i khi t√°c v·ª• th·∫•t b·∫°i</li>
            </ul>

            <h3>3.2. C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn</h3>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Lo·∫°i t√°c v·ª•</th>
                        <th>V√≠ d·ª•</th>
                        <th>L·ª£i √≠ch</th>
                    </tr>
                    <tr>
                        <td>Email v√† Notifications</td>
                        <td>G·ª≠i email x√°c nh·∫≠n, th√¥ng b√°o</td>
                        <td>Kh√¥ng l√†m ch·∫≠m response time</td>
                    </tr>
                    <tr>
                        <td>File Processing</td>
                        <td>X·ª≠ l√Ω import/export, resize ·∫£nh</td>
                        <td>X·ª≠ l√Ω file l·ªõn kh√¥ng block</td>
                    </tr>
                    <tr>
                        <td>Third-party API</td>
                        <td>ƒê·ªìng b·ªô d·ªØ li·ªáu, thanh to√°n</td>
                        <td>ƒê·ªôc l·∫≠p v·ªõi external services</td>
                    </tr>
                    <tr>
                        <td>Data Analytics</td>
                        <td>T√≠nh to√°n b√°o c√°o, th·ªëng k√™</td>
                        <td>X·ª≠ l√Ω d·ªØ li·ªáu l·ªõn hi·ªáu qu·∫£</td>
                    </tr>
                </table>
            </div>

            <h3>3.3. C·∫•u h√¨nh v√† Qu·∫£n l√Ω Jobs</h3>
            <p>Sidekiq l√† m·ªôt trong nh·ªØng adapter ph·ªï bi·∫øn nh·∫•t cho Active Job:</p>

            <div class="code-block">
                <pre><code><span class="comment"># config/initializers/sidekiq.rb</span>
<span class="class-name">Sidekiq</span>.<span class="method">configure_server</span> <span class="keyword">do</span> |<span class="variable">config</span>|
  <span class="variable">config</span>.<span class="variable">redis</span> = { <span class="symbol">url:</span> <span class="string">'redis://localhost:6379/0'</span> }

  <span class="comment"># C·∫•u h√¨nh retry</span>
  <span class="variable">config</span>.<span class="variable">average_scheduled_poll_interval</span> = <span class="number">5</span>
  <span class="variable">config</span>.<span class="variable">max_retries</span> = <span class="number">10</span>

  <span class="comment"># Dead job configuration</span>
  <span class="variable">config</span>.<span class="variable">death_handlers</span> << ->(job, ex) <span class="keyword">do</span>
    <span class="class-name">DeadJobNotifier</span>.<span class="method">notify</span>(<span class="variable">job</span>, <span class="variable">ex</span>)
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment"># app/jobs/complex_calculation_job.rb</span>
<span class="keyword">class</span> <span class="class-name">ComplexCalculationJob</span> < <span class="class-name">ApplicationJob</span>
  <span class="method">queue_as</span> <span class="symbol">:critical</span>

  <span class="method">retry_on</span> <span class="class-name">StandardError</span>, <span class="symbol">wait:</span> <span class="symbol">:exponentially_longer</span>, <span class="symbol">attempts:</span> <span class="number">5</span>
  <span class="method">discard_on</span> <span class="class-name">ActiveRecord::RecordNotFound</span>

  <span class="method">around_perform</span> <span class="symbol">:around_calculation</span>

  <span class="keyword">def</span> <span class="method-name">perform</span>(<span class="variable">report_id</span>)
    <span class="variable">report</span> = <span class="class-name">Report</span>.<span class="method">find</span>(<span class="variable">report_id</span>)
    <span class="variable">result</span> = <span class="method">calculate_complex_data</span>(<span class="variable">report</span>)
    <span class="method">update_report</span>(<span class="variable">report</span>, <span class="variable">result</span>)
  <span class="keyword">end</span>

  <span class="keyword">private</span>

  <span class="keyword">def</span> <span class="method-name">around_calculation</span>
    <span class="class-name">ActiveRecord::Base</span>.<span class="method">transaction</span> <span class="keyword">do</span>
      <span class="method">yield</span>
    <span class="keyword">end</span>
  <span class="keyword">rescue</span> => <span class="variable">e</span>
    <span class="class-name">Rails</span>.<span class="variable">logger</span>.<span class="method">error</span>(<span class="string">"Calculation failed: #{e.message}"</span>)
    <span class="method">raise</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>
            </div>

            <h3>3.4. Monitoring v√† Debug</h3>
            <p>C√°c c√¥ng c·ª• v√† practices ƒë·ªÉ theo d√µi background jobs:</p>

            <div class="code-block">
                <pre><code><span class="comment"># config/initializers/sidekiq.rb</span>
<span class="class-name">Sidekiq</span>.<span class="method">configure_server</span> <span class="keyword">do</span> |<span class="variable">config</span>|
  <span class="variable">config</span>.<span class="method">on</span>(<span class="symbol">:startup</span>) <span class="keyword">do</span>
    <span class="class-name">Schedule</span>.<span class="method">load_from_hash</span>(<span class="class-name">YAML</span>.<span class="method">load_file</span>(<span class="string">'config/schedule.yml'</span>))
  <span class="keyword">end</span>

  <span class="variable">config</span>.<span class="method">death_handlers</span> << ->(job, ex) <span class="keyword">do</span>
    <span class="class-name">Airbrake</span>.<span class="method">notify_sync</span>(<span class="variable">ex</span>, <span class="symbol">parameters:</span> <span class="variable">job</span>)
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment"># config/routes.rb</span>
<span class="method">require</span> <span class="string">'sidekiq/web'</span>
<span class="class-name">Rails</span>.<span class="method">application</span>.<span class="method">routes</span>.<span class="method">draw</span> <span class="keyword">do</span>
  <span class="method">authenticate</span> <span class="symbol">:admin</span> <span class="keyword">do</span>
    <span class="method">mount</span> <span class="class-name">Sidekiq::Web</span> => <span class="string">'/sidekiq'</span>
  <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>
            </div>

            <div class="warning">
                <strong>Nh·ªØng ƒëi·ªÉm c·∫ßn l∆∞u √Ω:</strong>
                <ul>
                    <li>Lu√¥n c√≥ c∆° ch·∫ø retry v√† error handling</li>
                    <li>S·ª≠ d·ª•ng c√°c queue kh√°c nhau cho c√°c lo·∫°i job kh√°c nhau</li>
                    <li>Monitoring v√† alerting cho failed jobs</li>
                    <li>C·∫©n th·∫≠n v·ªõi memory leaks trong long-running jobs</li>
                    <li>Backup v√† recovery strategy cho job queue</li>
                </ul>
            </div>

            <div class="tip">
                <strong>Performance Tips:</strong>
                <ul>
                    <li>Batch processing cho nhi·ªÅu jobs c√πng lo·∫°i</li>
                    <li>S·ª≠ d·ª•ng connection pool cho database connections</li>
                    <li>C·∫•u h√¨nh s·ªë l∆∞·ª£ng workers ph√π h·ª£p v·ªõi t√†i nguy√™n</li>
                    <li>Implement rate limiting cho c√°c API calls</li>
                </ul>
            </div>
        </div>

        <div class="content-section">
            <h2>4. T√†i li·ªáu tham kh·∫£o</h2>
            <ul class="reference-links">
                <li><a href="https://guides.rubyonrails.org/form_helpers.html#nested-forms" target="_blank">Rails Guides: Nested Forms</a></li>
                <li><a href="https://guides.rubyonrails.org/action_controller_overview.html#rescue-from" target="_blank">Rails Guides: Rescue From</a></li>
                <li><a href="https://guides.rubyonrails.org/active_job_basics.html" target="_blank">Rails Guides: Active Job Basics</a></li>
                <li><a href="https://github.com/mperham/sidekiq/wiki" target="_blank">Sidekiq Wiki</a></li>
                <li><a href="https://www.engineyard.com/blog/active-job-basics/" target="_blank">Engine Yard: Active Job Basics</a></li>
            </ul>
        </div>

        <footer>
            <p>¬© 2025 Ruby on Rails Tutorial - Advanced Features</p>
        </footer>
    </div>
</body>

</html>
